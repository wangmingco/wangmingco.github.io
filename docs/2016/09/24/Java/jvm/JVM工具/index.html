<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
   <!-- google 爬取标记 -->
   <meta name="google-site-verification" content="aH2bcbMuMlpfF61i9p--iBH54wvMywGXfWg8U6RpxFA" />
   <!-- bing 爬取标记 -->
   <meta name="msvalidate.01" content="CBAB9A13FF212142D6C250D9C0D31F28" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>JVM 工具 | 王明的技术博客</title>
  <meta name="description" content="工具列表 jmc jdk 自带的性能监控工具 hropf 这个是java agent工具, 用它可以监控JVM在运行时的CPU使用状况和堆内存分配以及监控器的一些信息.  jvmstat HotSpot™ Monitoring Tools and Utilities (-XX:+UsePerfData) Oracle® Solaris Studio 这是一款在Linux上使用的监控监控，它的监控">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM 工具">
<meta property="og:url" content="https://wangmingco.github.io/2016/09/24/Java/jvm/JVM%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="王明的技术博客">
<meta property="og:description" content="工具列表 jmc jdk 自带的性能监控工具 hropf 这个是java agent工具, 用它可以监控JVM在运行时的CPU使用状况和堆内存分配以及监控器的一些信息.  jvmstat HotSpot™ Monitoring Tools and Utilities (-XX:+UsePerfData) Oracle® Solaris Studio 这是一款在Linux上使用的监控监控，它的监控">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/5.png">
<meta property="article:published_time" content="2016-09-23T16:00:00.000Z">
<meta property="article:modified_time" content="2022-06-29T04:23:30.686Z">
<meta property="article:author" content="王明">
<meta property="article:tag" content="jvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wangmingco.github.io/2016/09/24/Java/jvm/JVM%E5%B7%A5%E5%85%B7/index.html">
  
    <link rel="alternate" href="/atom.xml" title="王明的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/wangmingco" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">王明</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Coder</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wangmingco" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://gitee.com/wangmingco" target="_blank" title="Gitee" data-toggle=tooltip data-placement=top><i class="icon icon-gitee"></i></a></li>
        
        <li><a href="https://weibo.com/wangmingco" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://www.zhihu.com/people/wangmingco" target="_blank" title="Zhihu" data-toggle=tooltip data-placement=top><i class="icon icon-zhihu"></i></a></li>
        
        <li><a href="https://www.douban.com/people/xxxyy/" target="_blank" title="Douban" data-toggle=tooltip data-placement=top><i class="icon icon-douban"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Groovy/">Groovy</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">142</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSql/">NoSql</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PYTHON2/">PYTHON2</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/awk/">awk</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/haskell/">haskell</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E6%96%87/">杂文</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">11</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E4%B8%89%E6%96%B9%E5%BA%93/" rel="tag">Java 三方库</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E7%BD%91%E7%BB%9C/" rel="tag">Java 网络</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaSE/" rel="tag">JavaSE</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javasist/" rel="tag">Javasist</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcached/" rel="tag">Memcached</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEG-js/" rel="tag">PEG.js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asm/" rel="tag">asm</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jmh/" rel="tag">jmh</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jol/" rel="tag">jol</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vertx2/" rel="tag">vertx2</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vertx3/" rel="tag">vertx3</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Java-%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 13.83px;">Java 三方库</a> <a href="/tags/Java-%E7%BD%91%E7%BB%9C/" style="font-size: 13.5px;">Java 网络</a> <a href="/tags/JavaSE/" style="font-size: 14px;">JavaSE</a> <a href="/tags/JavaScript/" style="font-size: 13.42px;">JavaScript</a> <a href="/tags/Javasist/" style="font-size: 13.25px;">Javasist</a> <a href="/tags/Memcached/" style="font-size: 13px;">Memcached</a> <a href="/tags/MongoDB/" style="font-size: 13.17px;">MongoDB</a> <a href="/tags/Netty/" style="font-size: 13.5px;">Netty</a> <a href="/tags/PEG-js/" style="font-size: 13px;">PEG.js</a> <a href="/tags/React/" style="font-size: 13px;">React</a> <a href="/tags/Redis/" style="font-size: 13.17px;">Redis</a> <a href="/tags/asm/" style="font-size: 13.25px;">asm</a> <a href="/tags/jmh/" style="font-size: 13.67px;">jmh</a> <a href="/tags/jol/" style="font-size: 13.92px;">jol</a> <a href="/tags/jvm/" style="font-size: 13.75px;">jvm</a> <a href="/tags/maven/" style="font-size: 13px;">maven</a> <a href="/tags/mybatis/" style="font-size: 13.58px;">mybatis</a> <a href="/tags/mysql/" style="font-size: 13.33px;">mysql</a> <a href="/tags/vertx2/" style="font-size: 13.08px;">vertx2</a> <a href="/tags/vertx3/" style="font-size: 13.25px;">vertx3</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/06/30/Java/mybatis/mybatis%20mapper%E5%8A%A0%E8%BD%BD/" class="title">(no title)</a>
              </p>
              <p class="item-date">
                <time datetime="2022-06-30T01:31:47.097Z" itemprop="datePublished">2022-06-30</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
              </p>
              <p class="item-title">
                <a href="/2022/06/20/%E6%95%B0%E6%8D%AE%E5%BA%93/sql/" class="title">SQL 手册</a>
              </p>
              <p class="item-date">
                <time datetime="2022-06-19T16:00:00.000Z" itemprop="datePublished">2022-06-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%9D%82%E6%96%87/">杂文</a>
              </p>
              <p class="item-title">
                <a href="/2022/06/01/%E6%9D%82%E6%96%87/duizhang/" class="title">对账</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-31T16:00:00.000Z" itemprop="datePublished">2022-06-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/04/12/%E5%89%8D%E7%AB%AF/REACT%20%E8%AF%AD%E6%B3%95/" class="title">React 学习</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-12T02:21:00.000Z" itemprop="datePublished">2022-04-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Java/">Java</a>
              </p>
              <p class="item-title">
                <a href="/2022/01/10/Java/jvm/centos%E7%BC%96%E8%AF%91openjdk/" class="title">Centos7 编译调试 OpenJDK11</a>
              </p>
              <p class="item-date">
                <time datetime="2022-01-09T16:00:00.000Z" itemprop="datePublished">2022-01-10</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-Java/jvm/JVM工具" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      JVM 工具
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2016/09/24/Java/jvm/JVM%E5%B7%A5%E5%85%B7/" class="article-date">
	  <time datetime="2016-09-23T16:00:00.000Z" itemprop="datePublished">2016-09-24</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/jvm/" rel="tag">jvm</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2016/09/24/Java/jvm/JVM%E5%B7%A5%E5%85%B7/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <script src="/assets/asciinema-player.js"></script><link rel="stylesheet" type="text/css" href="/assets/asciinema-player.css" />
<h2 id="工具列表"><a href="#工具列表" class="headerlink" title="工具列表"></a>工具列表</h2><ul>
<li><a href="">jmc</a> jdk 自带的性能监控工具</li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/samples/hprof.html">hropf</a> 这个是java agent工具, 用它可以监控JVM在运行时的CPU使用状况和堆内存分配以及监控器的一些信息. </li>
<li><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/jvmstat.html#Installation">jvmstat</a> HotSpot™ Monitoring Tools and Utilities (-XX:+UsePerfData)</li>
<li><a target="_blank" rel="noopener" href="https://www.oracle.com/tools/developerstudio/downloads/solaris-studio-v123-downloads.html">Oracle® Solaris Studio</a> 这是一款在Linux上使用的监控监控，它的监控端和桌面端都在Linux上。</li>
<li><a target="_blank" rel="noopener" href="http://www.javaperformancetuning.com/tools/hpjmeter/index.shtml">hpjmeter</a> 分析gc产生的日志</li>
<li><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/jperfanal/">JPerfAnal</a> </li>
<li><a target="_blank" rel="noopener" href="https://planet.jboss.org/post/simple_tools_to_analyze_thread_dumps">Simple Tools To Analyze Thread Dumps</a></li>
<li><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/tdv/?source=recommended">Thread Dump Viewer</a></li>
<li><a target="_blank" rel="noopener" href="https://java.net/projects/tda">TDA - Thread Dump Analyzer</a></li>
<li><a target="_blank" rel="noopener" href="http://mchr3k.github.io/javathreaddumpanalyser/">Java Thread Dump Analyser</a></li>
<li><a href="">IBM Thread and Monitor Dump Analyzer for Java</a></li>
</ul>
<h2 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h2><p>在JVisualVM中有俩个统计类的tab: 抽样器和profiler，那么这俩个有什么不一样呢？</p>
<ul>
<li><code>Profiler</code>: 会通过 instrument 技术(对就是JDK5提出的那个技术)， 向目标虚拟机的代码进行代码注入。 例如profile cpu的时候会向所有的方法添加统计代码(添加额外的字节码)，这些代码会记录下来这些方法是何时被调用的，以及每一次调用都使用了多长时间</li>
<li><code>Sample</code>: 进行采样分析. 同样是在采样CPU, 它会每隔一段时间dump下所有的线程信息, 然后粗略地算出每个方法占用的CPU的时间。</li>
</ul>
<p>在线上环境中切记不要使用profiler</p>
<h2 id="jmc"><a href="#jmc" class="headerlink" title="jmc"></a>jmc</h2><p>Java启动时手动开启 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:StartFlightRecording=duration=60s,filename=myrecording.jfr MyApp</span><br></pre></td></tr></table></figure>

<p>为应用开启飞行记录。 这时一个商业特性和-XX:+UnlockCommercialFeatures选项一起使用。这个选项类似JFR.start命令。你可以设置一下参数：</p>
<ul>
<li><code>compress=&#123;true|false&#125;</code>  指定是否压缩</li>
<li><code>defaultrecording=&#123;true|false&#125;</code> 指定后台的飞行记录是一直运行还是只运行一段时间。默认这个参数的值是false，也就是运行一段时间，</li>
<li><code>delay=time</code> 指定再启动JVM后多长时间开始记录飞行记录。默认没有延迟时间。</li>
<li><code>dumponexit=&#123;true|false&#125;</code> 指定在JVM退出的时候是否生成飞行记录数据。默认这个参数是false。如果需要生成如下所示： <code>-XX:StartFlightRecording=name=test,filename=D:\test.jfr,dumponexit=true</code></li>
<li><code>duration=time</code> 指定飞行记录执行的时间。默认没有限制。</li>
<li><code>filename=path</code> 指定JFR记录的路径和文件</li>
<li><code>name=identifier</code> 指定JFR记录的标识。默认Recording 是x。</li>
<li><code>maxage=time</code> 指定飞行记录保存的时间。默认是15分钟</li>
<li><code>settings=path</code> 设置事件配置文件，默认使用<code>default.jfc</code>.这个文件在<code>JAVA_HOME/jre/lib/jfr</code></li>
</ul>
<h2 id="hropf"><a href="#hropf" class="headerlink" title="hropf"></a>hropf</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/samples/hprof.html">hropf</a> 这个是java agent工具, 用它可以监控JVM在运行时的CPU使用状况和堆内存分配以及监控器的一些信息. </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  test java -agentlib:hprof=help</span><br><span class="line"></span><br><span class="line">     HPROF: Heap and CPU Profiling Agent (JVMTI Demonstration Code)</span><br><span class="line"></span><br><span class="line">hprof usage: java -agentlib:hprof=[help]|[&lt;option&gt;=&lt;value&gt;, ...]</span><br><span class="line"></span><br><span class="line">Option Name and Value  Description                    Default</span><br><span class="line">---------------------  -----------                    -------</span><br><span class="line">heap=dump|sites|all    heap profiling                 all</span><br><span class="line">cpu=samples|times|old  CPU usage                      off</span><br><span class="line">monitor=y|n            monitor contention             n</span><br><span class="line">format=a|b             text(txt) or binary output     a</span><br><span class="line">file=&lt;file&gt;            write data to file             java.hprof[&#123;.txt&#125;]</span><br><span class="line">net=&lt;host&gt;:&lt;port&gt;      send data over a socket        off</span><br><span class="line">depth=&lt;size&gt;           stack trace depth              4</span><br><span class="line">interval=&lt;ms&gt;          sample interval in ms          10</span><br><span class="line">cutoff=&lt;value&gt;         output cutoff point            0.0001</span><br><span class="line">lineno=y|n             line number in traces?         y</span><br><span class="line">thread=y|n             thread in traces?              n</span><br><span class="line">doe=y|n                dump on exit?                  y</span><br><span class="line">msa=y|n                Solaris micro state accounting n</span><br><span class="line">force=y|n              force output to &lt;file&gt;         y</span><br><span class="line">verbose=y|n            print messages about dumps     y</span><br><span class="line"></span><br><span class="line">Obsolete Options</span><br><span class="line">----------------</span><br><span class="line">gc_okay=y|n</span><br></pre></td></tr></table></figure>

<p>每20毫秒统计一次CPU信息(栈深度为3):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -agentlib:hprof=cpu=samples,interval=20,depth=3 classname</span><br></pre></td></tr></table></figure>

<p>注意:</p>
<ul>
<li> <code>format=b</code>不能和<code>monitor=y</code>一起使用</li>
<li> <code>format=b</code>不能和<code>cpu=old|times</code>一起使用</li>
<li> <code>-Xrunhprof</code>接口可以继续使用, 例如<code>java -Xrunhprof:[help]|[&lt;option&gt;=&lt;value&gt;, ...]</code>.这个等同于<code>java -agentlib:hprof=[help]|[&lt;option&gt;=&lt;value&gt;, ...]</code></li>
</ul>
<p>我们看一个很简单的统计函数运行时间的示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -agentlib:hprof=cpu=times,interval=10 Test</span><br></pre></td></tr></table></figure>

<h2 id="jvmstat"><a href="#jvmstat" class="headerlink" title="jvmstat"></a>jvmstat</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/jvmstat.html#Installation">jvmstat</a> HotSpot™ Monitoring Tools and Utilities (-XX:+UsePerfData)</li>
<li><a target="_blank" rel="noopener" href="https://openjdk.org/groups/hotspot/docs/Serviceability.html#bjvmstat">HotSpot Jvmstat Performance Counters</a></li>
</ul>
<p>可以使用  jps, jstat, and jstatd 这三个 工具监控JVM的性能和资源消耗。</p>
<ul>
<li>jps Experimental: JVM Process Status Tool - Lists instrumented HotSpot Java virtual machines on a target system. (formerly jvmps)</li>
<li>jstat Experimental: JVM Statistics Monitoring Tool - Attaches to an instrumented HotSpot Java virtual machine and collects and logs performance statistics as specified by the command line options. (formerly jvmstat)</li>
<li>jstatd :Experimental: JVM jstat Daemon - Launches an RMI server application that monitors for the creation and termination of instrumented HotSpot Java virtual machines and provides a interface to allow remote monitoring tools to attach to Java virtual machines running on the local system. (formerly perfagent)</li>
</ul>
<p>Hotspot出于性能测试和排查问题的目的而提供了jvmstat 工具. 我们可以使用JVM参数-XX:+UsePerfData来决定是否开启这个功能. 因此jvm运行时会生成一个目录hsperfdata_$USER($USER是启动java进程的用户,在linux中默认是/tmp),目录下会有些java 进程的 pid文件. 文件内部存储的是jvmstat统计的jvm进程的相关信息.</p>
<blockquote>
<p>jvmstat源码参考 <code>openjdk\jdk\src\share\classes\sun\jvmstat</code></p>
</blockquote>
<p>当我们将/tmp/hsperfdata目录下的某个进程文件删除之后, 相应的进程也就消失了, 经过测试即使Java进程里已经注册了钩子程序, 但是钩子程序也不会执行, 进程就直接消失了. 而且进程消失之后, 这个文件也就没有了.</p>
<p>PerfData 相关的JVM选项</p>
<ul>
<li><code>-XX:+UsePerfData</code> 用于设置是否开启统计.(默认值为true, 开启)</li>
<li><code>-XX:+PerfDataSaveToFile</code> 在系统退出时是否将PerfData 内存数据保存到hsperfdata_ 文件(默认为false, 不开启). 注意这个数据是保存到Java进程当前的工作目录, 而不是/tmp下</li>
<li><code>PerfDataSamplingInterval</code> 统计采样间隔(单位毫秒, 默认是50毫秒)</li>
<li><code>PerfDisableSharedMem</code> 是否将标准内存的性能数据进行存储(默认为false, 不存储)</li>
<li><code>PerfDataMemorySize</code> 性能统计数据可存储大小. 总是对操作系统内存页的大小进行取整(默认是32k)。 因为在内存中保存的是32k的数据, 因此存储到文件之后, 文件的大小也固定在32k.</li>
</ul>
<p>我们可以使用jdk提供的一些工具来读取这个目录下的JVM进程信息统计文件, 例如jstat读取<code>/tmp/hsperfdata_username/</code>目录下的文件查看虚拟机老年代的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@root wangming]# jstat -gcold file:///tmp/hsperfdata_username/2332 </span><br><span class="line">   MC       MU      CCSC     CCSU       OC          OU       YGC    FGC    FGCT     GCT   </span><br><span class="line"> 26112.0  25379.2   3840.0   3719.1    164864.0     18007.6    495     1    0.102    2.377</span><br></pre></td></tr></table></figure>

<h2 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h2><ul>
<li>[虚拟机统计信息监视工具])(<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html">https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html</a>)</li>
</ul>
<p>虚拟机统计信息监视工具</p>
<p>用于监视虚拟机各种运行状态信息的命令行工具.它可以显示本地或远程虚拟机进程中的类装载,内存,垃圾收集,JIT编译等运行数据.</p>
<p>jstat命令格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</span><br></pre></td></tr></table></figure>

<p>对于命令格式中的VMID与LVMID需要特别说明一下:如果是本地虚拟机进程,VMID和LVMID是一致的,如果是远程虚拟机进程,那么VMID的格式应该是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[protocol:] [//]lvmid[@hostname [:port] /servername]</span><br></pre></td></tr></table></figure>

<p>option参数代表着用户希望查询的虚拟机信息,主要分为三类:类装载,垃圾收集,运行期编译状况, 可选值有:</p>
<ul>
<li> <code>-class</code>: 监视类装载,卸载数量,总空间及类装载所耗费的时间</li>
<li> <code>-gc</code>: 监视java堆状况,包括Eden区,2个survivor区,老年代,永久代等的容量,已用空间,GC时间合计等信息.</li>
<li> <code>-gccapacity</code>: 监视内容与-gc基本相同,但输出主要关注java堆各个区域使用到最大和最小空间.</li>
<li> <code>-gcutil</code>: 监视内容与-gc基本相同,但输出主要关注已使用空间占总空间的百分比.</li>
<li> <code>-gccause</code>: 与-gcutil功能一样,但是会额外输出导致上一次GC产生的原因.</li>
<li> <code>-gcnew</code>:监视新生代GC的状况.</li>
<li> <code>-gcnewcapacity</code>: 监视内容与-gcnew基本相同输出主要关注使用到的最大和最小空间</li>
<li> <code>-gcold</code>: 监视老年代GC的状况.</li>
<li> <code>-gcoldcapacity</code>: 监视内容与-gcold基本相同,但输出主要关注使用到的最大和最小空间</li>
<li> <code>-gcpermcapacity</code>: 输出永久代使用到呃最大和最小空间</li>
<li> <code>-compiler</code>: 输出JIT编译器编译过的方法,耗时等信息</li>
<li> <code>-printcompilation</code>: 输出已经被JIT编译的方法.</li>
</ul>
<p>其他参数</p>
<ul>
<li><code>-t</code>:  在输出信息前添加一个时间, 表示程序运行的时间</li>
<li><code>-h</code>:  表示输出多少行后,输出一个表头信息</li>
<li><code>interval</code>:  统计数据的周期, 单位是毫秒</li>
<li><code>count</code>:  统计的次数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  test jstat -gc  -t  2028 5000 5</span><br><span class="line">Timestamp        S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">          200.8 4608.0 4096.0  0.0   3152.8 39936.0   8518.2   17920.0    13639.7   27520.0 27031.4 3456.0 3372.0     23    0.078   2      0.149    0.227</span><br><span class="line">          205.9 4608.0 4096.0  0.0   3152.8 39936.0   8518.2   17920.0    13639.7   27520.0 27031.4 3456.0 3372.0     23    0.078   2      0.149    0.227</span><br><span class="line">          210.9 4608.0 4096.0  0.0   3152.8 39936.0   8518.2   17920.0    13639.7   27520.0 27031.4 3456.0 3372.0     23    0.078   2      0.149    0.227</span><br><span class="line">          215.9 4608.0 4096.0  0.0   3152.8 39936.0   8518.2   17920.0    13639.7   27520.0 27031.4 3456.0 3372.0     23    0.078   2      0.149    0.227</span><br><span class="line">          220.9 4608.0 4096.0  0.0   3152.8 39936.0   8518.2   17920.0    13639.7   27520.0 27031.4 3456.0 3372.0     23    0.078   2      0.149    0.227</span><br></pre></td></tr></table></figure>

<ul>
<li> <code>Timestamp</code> 程序运行的时间</li>
<li> <code>S0C</code> survive0的大小(单位KB)</li>
<li> <code>S1C</code> survive1的大小(单位KB)</li>
<li> <code>S0U</code> survive0使用的大小(单位KB)</li>
<li> <code>S1U</code> survive1使用的大小(单位KB)</li>
<li> <code>EC</code> eden区大小(单位KB)</li>
<li> <code>EU</code> eden区使用的大小(单位KB)</li>
<li> <code>OC</code> 老年代大小(单位KB)</li>
<li> <code>OU</code> 老年代使用的大小(单位KB)</li>
<li> <code>MC</code> 元数据区大小(单位KB)</li>
<li> <code>MU</code> 元数据区使用大小(单位KB)</li>
<li> <code>CCSC</code></li>
<li> <code>CCSU</code></li>
<li> <code>YGC</code> 新生代GC次数</li>
<li> <code>YGCT</code> 新生代GC耗时</li>
<li> <code>FGC</code> FullGC次数</li>
<li> <code>FGCT</code> FullGC耗时</li>
<li> <code>GCT</code> GC总耗时</li>
</ul>
<h2 id="Oracle®-Solaris-Studio"><a href="#Oracle®-Solaris-Studio" class="headerlink" title="Oracle® Solaris Studio"></a>Oracle® Solaris Studio</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.oracle.com/tools/developerstudio/downloads/solaris-studio-v123-downloads.html">Oracle® Solaris Studio</a> 这是一款在Linux上使用的监控监控，它的监控端和桌面端都在Linux上。</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>在Centos上安装Oracle® Solaris Studio. <a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E27071_01/html/E26451/gemyt.html#scrolltoc">中文教程</a></p>
<p>首先执行下列命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install glibc</span><br><span class="line">yum install elfutils-libelf-devel</span><br><span class="line">yum install zlib</span><br><span class="line">yum install libstdc++</span><br><span class="line">yum install libgcc</span><br></pre></td></tr></table></figure>
<p>执行完之后, 会将下列依赖包安装完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">glibc</span><br><span class="line">glibc.i686</span><br><span class="line">glibc-devel</span><br><span class="line">glibc-devel.i686</span><br><span class="line">elfutils-libelf-devel </span><br><span class="line">elfutils-libelf-devel.i686</span><br><span class="line">zlib</span><br><span class="line">zlib.i686</span><br><span class="line">libstdc++</span><br><span class="line">libstdc++.i686</span><br><span class="line">libgcc</span><br><span class="line">libgcc.i686</span><br></pre></td></tr></table></figure>

<ol>
<li>在<a href="www.oracle.com/technetwork/server-storage/solarisstudio/downloads/index.html">下载界面</a>下载<code>Oracle Linux/ Red Hat Linux - RPM installer on x86</code></li>
<li>运行命令解压<code>bzcat download_directory/SolarisStudio12.4-linux-x86-rpm.tar.bz2 | /bin/tar -xf -</code></li>
<li>进行安装<code>./solarisstudio.sh --non-interactive</code>(包含GUI, 也就是我们可以在Linux的桌面上打开Solaris Studio IDE)</li>
<li>验证是否安装成功<code>/opt/oracle/solarisstudio12.4/bin/analyzer -v</code></li>
</ol>
<p>安装完成后会显示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Configuring the installer...</span><br><span class="line">Searching for JVM on the system...</span><br><span class="line">Extracting installation data (can take a while, please wait)...</span><br><span class="line">Running the installer wizard...</span><br><span class="line">/tmp/ossi-c2x_test-20160509142618.silent.log:</span><br><span class="line">[2016-05-09 14:26:18.764]: WARNING - Your OS distribution is not supported. The list of supported systems can be found in the Oracle Solaris Studio documentation. While it might be possible to install Oracle Solaris Studio on your system, it might not function properly.</span><br></pre></td></tr></table></figure>

<p>运行analyzer -v显示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">analyzer: Oracle Solaris Studio 12.4 Performance Analyzer 12.4 Linux_x64 2014/10/21</span><br><span class="line">Java at /usr/java/jdk1.8.0_25/bin/java selected by PATH</span><br><span class="line">java version &quot;1.8.0_25&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_25-b17)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.25-b02, mixed mode)</span><br><span class="line">WARNING: Linux CentOS_6.7 system &quot;c2x_test&quot; is not supported by the Performance tools.</span><br><span class="line">Running /usr/java/jdk1.8.0_25/bin/java -version</span><br><span class="line">/opt/oracle/solarisstudio12.4/bin/analyzer: ERROR: environment variable DISPLAY is not set</span><br></pre></td></tr></table></figure>

<p>额外事项</p>
<ol>
<li>卸载程序 <code>/opt/oracle/solarisstudio12.4/uninstall.sh --non-interactive</code></li>
<li>如果安装时不想要GUI, 只需要在后面加上<code>--libraries-only</code>就好了</li>
<li>设置环境变量 <code>vi /ect/profile</code> 修改<code>PATH=$PATH:/opt/oracle/solarisstudio12.4/bin/</code></li>
</ol>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><p>安装完之后打开(<code>/opt/oracle/developerstudio12.5/bin /analyzer</code> 文件)，由于在服务器上安装的，只能在本地通过TightVNC打开了</p>
<p><img src="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/1.png"></p>
<p>开启Java进程的时候运行下面的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collect -j on -d /home/bjadmin/game/profile/gateway /home/jdk1.8/bin/java -cp .;./* com.xpec.gateway.GatewayServerMain ./configs</span><br></pre></td></tr></table></figure>

<p>想要查看统计结果的话就运行下面的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@c2xceshi profile]# /opt/oracle/developerstudio12.5/bin/analyzer ./zone/test.1.er/</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/2.png"><br><img src="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/3.png"><br><img src="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/4.png"><br><img src="https://raw.githubusercontent.com/wangmingco/wangmingco.github.io/main/static/images/OracleSolarisStudio/5.png"></p>
<h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p><code>jstack</code>命令用于生成虚拟机当前时刻的线程快照.</p>
<p>线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合,生成线程快照的主要目的是定位线程出现长时间停顿的原因,如<a href="">线程间死锁</a>,<a href="">死循环</a>,请求外部资源导致长时间等待.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">D:\work\test\target\classes&gt;jstack -help</span><br><span class="line">Usage:</span><br><span class="line">    jstack [-l] &lt;pid&gt;</span><br><span class="line">        (to connect to running process, 连接正在运行的进程)</span><br><span class="line">    jstack -F [-m] [-l] &lt;pid&gt;</span><br><span class="line">        (to connect to a hung process, 连接已经宕掉的进程)</span><br><span class="line">    jstack [-m] [-l] &lt;executable&gt; &lt;core&gt;</span><br><span class="line">        (to connect to a core file, 连接一个core文件)</span><br><span class="line">    jstack [-m] [-l] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to a remote debug server, 连接一个远程的debug Server)</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    -F  to force a thread dump. Use when jstack &lt;pid&gt; does not respond (process is hung). 当正常输出的请求不被响应时,强制说出线程堆栈</span><br><span class="line">    -m  to print both java and native frames (mixed mode). 如果调用本地方法的话,可以显示c/c++的堆栈</span><br><span class="line">    -l  long listing. Prints additional information about locks. 除堆栈外,显示关于锁的附加信息</span><br><span class="line">    -h or -help to print this help message</span><br></pre></td></tr></table></figure>

<p>jstack日志, 下面摘抄的是NETTY中空epoll的一段记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&quot;nioEventLoopGroup-2461-1&quot; #4955 prio=10 os_prio=0 tid=0x00007fd857e9a000 nid=0x5e19 runnable [0x00007fd7374bc000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">    at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)</span><br><span class="line">    at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:269)</span><br><span class="line">    at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:79)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:86)</span><br><span class="line">    - locked &lt;0x00000000e673cf38&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</span><br><span class="line">    - locked &lt;0x00000000e673cd30&gt; (a java.util.Collections$UnmodifiableSet)</span><br><span class="line">    - locked &lt;0x00000000e673cc58&gt; (a sun.nio.ch.EPollSelectorImpl)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:97)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.select(NioEventLoop.java:622)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:310)</span><br><span class="line">    at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:116)</span><br><span class="line">    at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">    - None</span><br></pre></td></tr></table></figure>

<p>第一行数据分析   nioEventLoopGroup-2461-1 表示的是进程名字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#4955</span><br><span class="line">prio=10</span><br><span class="line">os_prio=0</span><br><span class="line">nid: 线程ID的16进制表示(可以通过`top -H`查看pid)</span><br><span class="line">tid:</span><br><span class="line">runnable</span><br><span class="line">[0x00007fd7374bc000]`</span><br></pre></td></tr></table></figure>

<p>线程堆栈信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Thread.State 线程状态</span><br><span class="line">locked` 锁住的资源,分别锁住了  &lt;0x00000000e673cf38&gt;, &lt;0x00000000e673cd30&gt;, &lt;0x00000000e673cc58&gt;</span><br></pre></td></tr></table></figure>

<p>java.lang.Thread.State 线程状态</p>
<ul>
<li><p> <code>Runnable </code> : 线程具备所有运行条件，在运行队列中准备操作系统的调度，或者正在运行</p>
</li>
<li><p> <code>waiting for monitor entry</code> :  在等待进入一个临界区,所以它在<code>Entry Set</code>队列中等待.此时线程状态一般都是 <code>Blocked</code>:如果大量线程在<code>waiting for monitor entry</code>, 可能是一个全局锁阻塞住了大量线程.如果短时间内打印的 <code>thread dump</code> 文件反映,随着时间流逝,<code>waiting for monitor entry</code>的线程越来越多,没有减少的趋势,可能意味着某些线程在临界区里呆的时间太长了,以至于越来越多新线程迟迟无法进入临界区.</p>
</li>
<li><p> <code>waiting on condition</code> : 说明它在等待另一个条件的发生,来把自己唤醒,或者干脆它是调用了 <code>sleep(N)</code>.如果大量线程在<code>waiting on condition</code>：可能是它们又跑去获取第三方资源,尤其是第三方网络资源,迟迟获取不到<code>Response</code>,导致大量线程进入等待状态.所以如果你发现有大量的线程都处在 <code>Wait on condition</code>,从线程堆栈看,正等待网络读写,这可能是一个网络瓶颈的征兆,因为网络阻塞导致线程无法执行.  此时线程状态大致为以下几种：<code>java.lang.Thread.State: WAITING (parking)</code>：一直等那个条件发生；<code>java.lang.Thread.State: TIMED_WAITING</code> (<code>parking</code>或<code>sleeping</code>)：定时的,那个条件不到来,也将定时唤醒自己.</p>
</li>
<li><p><code>in Object.wait()</code> : 说明它获得了监视器之后,又调用了 <code>java.lang.Object.wait()</code> 方法. 每个 Monitor在某个时刻,只能被一个线程拥有,该线程就是 <code>Active Thread</code>,而其它线程都是 <code>Waiting Thread</code>,分别在两个队列 <code>Entry Set</code>和 <code>Wait Set</code>里面等候.在 <code>Entry Set</code>中等待的线程状态是 <code>Waiting for monitor entry</code>,而在 <code>Wait Set</code>中等待的线程状态是 <code>in Object.wait()</code>.当线程获得了 <code>Monitor</code>,如果发现线程继续运行的条件没有满足,它则调用对象(一般就是被 <code>synchronized</code> 的对象)的 <code>wait()</code> 方法,放弃了 <code>Monitor</code>,进入 <code>Wait Set</code>队列. 此时线程状态大致为以下几种：1. <code>java.lang.Thread.State: TIMED_WAITING (on object monitor)</code>;  2. <code>java.lang.Thread.State: WAITING (on object monitor)</code>;</p>
</li>
</ul>
<p>从上面的源码我们可以看到, JStack会根据选项参数来判断是使用<a href="">SA JStack tool</a> 还是 <a href="">VM attach mechanism</a> 输出线程的堆栈信息. 在下面的情况下会使用SA JStack tool</p>
<ul>
<li>有<code>-F</code>选项</li>
<li>有<code>-m</code>选项</li>
<li>有<code>&lt;executable&gt; &lt;core&gt; </code>参数</li>
<li>有<code>[server_id@]&lt;remote server IP or hostname&gt;</code>参数</li>
</ul>
<h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><p>java内存映射工具,用于生成堆转储快照.</p>
<p>如果不使用jmap命令,想要获取java堆转储快照还有一些比较暴力的手段:</p>
<ul>
<li>  <code>-XX:+HeapDumpOnOutOfMemoryError</code> :  可以让虚拟机在OOM异常自动生成dump文件,通过</li>
<li>  <code>-XX:+HeapDumpOnCtrlBreak</code> ： 参数则可以使用<code>[CTRL] + [Break]</code>: 键让虚拟机生成dump文件,又或者在Linux系统<br>下通过<code>kill -3</code>命令发送进程退出信号,也能拿到dump文件.</li>
</ul>
<p>jmap的作用并不仅仅是为了获取dump文件,它还可以查询<code>finalize</code>执行队列,java堆和永久代的详细信息,如空间使用率,当前使用的是哪种收集器.</p>
<p>和jinfo命令一样,jmap有不少功能是在windows平台下受限的,除了生成dump文件<code>-dump</code>选项和用于查看每个类的实例,空间占用统计的<code>-histo</code>选项所有系统操作系统都提供之外,其余选项只能在Linux/Solaris下使用.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;jmap -help</span><br><span class="line">Usage:</span><br><span class="line">    jmap [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jmap [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               to print same info as Solaris pmap</span><br><span class="line">    -heap                打印Java堆概览</span><br><span class="line">    -histo[:live]        打印Java堆得对象柱状分布图; 如果指定&quot;live&quot; 的话, 那么就只统计存活的对象</span><br><span class="line">    -clstats             打印class 加载的统计信息</span><br><span class="line">    -finalizerinfo       to print information on objects awaiting finalization</span><br><span class="line">    -dump:&lt;dump-options&gt; 以二进制格式dump JVM 堆内存信息 (示例: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;)</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         只dump 存活的对象; 如果不指定的话, 堆内存内的所有对象都会被dump出来.</span><br><span class="line">                           format=b     二进制格式</span><br><span class="line">                           file=&lt;file&gt;  dump 堆内存到哪个文件</span><br><span class="line"></span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo to force a heap dump or histogram when &lt;pid&gt; does not respond. The &quot;live&quot; suboption is not supported in this mode.</span><br><span class="line">    -h | -help           to print this help message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>jmap工具主要选项</p>
<ul>
<li> <code>-dump</code>: 生成java堆转储快照.格式为:<code>-dump:[live,]format=b,file=&lt;filename&gt;</code>.live表示只dump存活对象</li>
<li> <code>-finalizerinfo</code>: 显示在<code>F-Queue</code>中等待<code>Finalizer</code>线程执行<code>finalize</code>方法的对象.</li>
<li> <code>-heap</code>: 显示java堆的详细信息,使用哪种回收器,参数配置,分代状况.</li>
<li> <code>-histo</code>: 显示堆中对象统计信息,包括类,实例数量和合计容量</li>
<li> <code>-permstat</code>: 以<code>ClassLoader</code>为统计口径显示永久代内存状态.</li>
<li> <code>-F</code>: 当虚拟机进程对<code>-dump</code>选项没有响应时,可使用这个选项强制生成dump快照</li>
</ul>
<p>获取当前进程的堆快照</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ test jmap -dump:live,format=b,file=2028dump 2028</span><br><span class="line">Dumping heap to /Users/wangming/Desktop/test/2028dump ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<p>获取当前进程的对象统计信息, 下面统计出了数量大于10000个对象的类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ test jmap -histo 2028 | awk &#x27;&#123;if($2&gt; 10000) print $1 &quot;  &quot; $2 &quot;  &quot;  $3 &quot;  &quot; $4 &#125;&#x27;</span><br><span class="line">1:  36397  6363208  [C</span><br><span class="line">3:  35324  847776  java.lang.String</span><br><span class="line">7:  10522  336704  java.util.concurrent.ConcurrentHashMap$Node</span><br><span class="line">Total  207899  14900384</span><br></pre></td></tr></table></figure>

<p>jmap 命令支持三种模式, 分别是本地进程, core文件和远程进程模式.</p>
<p>JMap类是jmap命令的封装实现类. 这个类同样是由参数决定来调用<a href="">VM attach mechanism</a>还是<a href="">SA tool</a>.</p>
<blockquote>
<p>现在只有<code>-heap</code>,<code>-finalizerinfo</code>和<code>-F</code>选项下会使用<a href="">VM attach mechanism</a>,其他的情况都是使用<a href="">SA tools</a>.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> sun.tools.attach.HotSpotVirtualMachine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 attach mechanism 的选项</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String HISTO_OPTION = <span class="string">&quot;-histo&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String LIVE_HISTO_OPTION = <span class="string">&quot;-histo:live&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String DUMP_OPTION_PREFIX = <span class="string">&quot;-dump:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 SA tool 的选项</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String SA_TOOL_OPTIONS = <span class="string">&quot;-heap|-heap:format=b|-permstat|-finalizerinfo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The -F (force) option is currently not passed through to SA</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String FORCE_SA_OPTION = <span class="string">&quot;-F&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default option (if nothing provided)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String DEFAULT_OPTION = <span class="string">&quot;-pmap&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span><br><span class="line">            usage(); <span class="comment">// no arguments</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> useSA = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 例如选中的选项 (-heap, -dump:*, ... )</span></span><br><span class="line">        String option = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 开始遍历所有的选项(选项以-开始). 如果选项中不包含-F, 则应该只有一个选项</span></span><br><span class="line">        <span class="keyword">int</span> optionCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (optionCount &lt; args.length) &#123;</span><br><span class="line">            String arg = args[optionCount];</span><br><span class="line">            <span class="keyword">if</span> (!arg.startsWith(<span class="string">&quot;-&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断是否是-F选项, 如果是则使用SA</span></span><br><span class="line">            <span class="keyword">if</span> (arg.equals(FORCE_SA_OPTION)) &#123;</span><br><span class="line">                useSA = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (option != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    usage();  <span class="comment">// option already specified</span></span><br><span class="line">                &#125;</span><br><span class="line">                option = arg;</span><br><span class="line">            &#125;</span><br><span class="line">            optionCount++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if no option provided then use default.</span></span><br><span class="line">        <span class="keyword">if</span> (option == <span class="keyword">null</span>) &#123;</span><br><span class="line">            option = DEFAULT_OPTION;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (option.matches(SA_TOOL_OPTIONS)) &#123;</span><br><span class="line">            useSA = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下面开始检查参数个数. SA Tool只会使用1或者2个参数. 在使用-dump参数时只会使用一个参数</span></span><br><span class="line">        <span class="keyword">int</span> paramCount = args.length - optionCount;</span><br><span class="line">        <span class="keyword">if</span> (paramCount == <span class="number">0</span> || paramCount &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            usage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (optionCount == <span class="number">0</span> || paramCount != <span class="number">1</span>) &#123;</span><br><span class="line">            useSA = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果只有一个参数且没办法解析成pid的话, 那么肯定是要连接一个debug server, 也要使用SA Tool</span></span><br><span class="line">            <span class="keyword">if</span> (!args[optionCount].matches(<span class="string">&quot;[0-9]+&quot;</span>)) &#123;</span><br><span class="line">                useSA = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (useSA) &#123;</span><br><span class="line">            <span class="comment">// parameters (&lt;pid&gt; or &lt;exe&gt; &lt;core&gt;)</span></span><br><span class="line">            String params[] = <span class="keyword">new</span> String[paramCount];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=optionCount; i&lt;args.length; i++ )&#123;</span><br><span class="line">                params[i-optionCount] = args[i];</span><br><span class="line">            &#125;</span><br><span class="line">            runTool(option, params);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 开始调用VirtualMachine相关的接口方法</span></span><br><span class="line">            String pid = args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (option.equals(HISTO_OPTION)) &#123;</span><br><span class="line">                histo(pid, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option.equals(LIVE_HISTO_OPTION)) &#123;</span><br><span class="line">                histo(pid, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option.startsWith(DUMP_OPTION_PREFIX)) &#123;</span><br><span class="line">                dump(pid, option);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                usage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 SA tool</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTool</span><span class="params">(String option, String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[][] tools = &#123;</span><br><span class="line">                &#123; <span class="string">&quot;-pmap&quot;</span>,           <span class="string">&quot;sun.jvm.hotspot.tools.PMap&quot;</span>     &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;-heap&quot;</span>,           <span class="string">&quot;sun.jvm.hotspot.tools.HeapSummary&quot;</span>     &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;-heap:format=b&quot;</span>,  <span class="string">&quot;sun.jvm.hotspot.tools.HeapDumper&quot;</span>      &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;-histo&quot;</span>,          <span class="string">&quot;sun.jvm.hotspot.tools.ObjectHistogram&quot;</span> &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;-permstat&quot;</span>,       <span class="string">&quot;sun.jvm.hotspot.tools.PermStat&quot;</span>        &#125;,</span><br><span class="line">                &#123; <span class="string">&quot;-finalizerinfo&quot;</span>,  <span class="string">&quot;sun.jvm.hotspot.tools.FinalizerInfo&quot;</span>   &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        String tool = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -dump option needs to be handled in a special way</span></span><br><span class="line">        <span class="keyword">if</span> (option.startsWith(DUMP_OPTION_PREFIX)) &#123;</span><br><span class="line">            <span class="comment">// first check that the option can be parsed</span></span><br><span class="line">            String fn = parseDumpOptions(option);</span><br><span class="line">            <span class="keyword">if</span> (fn == <span class="keyword">null</span>) usage();</span><br><span class="line">            <span class="comment">// tool for heap dumping</span></span><br><span class="line">            tool = <span class="string">&quot;sun.jvm.hotspot.tools.HeapDumper&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// HeapDumper -f &lt;file&gt;</span></span><br><span class="line">            args = prepend(fn, args);</span><br><span class="line">            args = prepend(<span class="string">&quot;-f&quot;</span>, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; tools.length) &#123;</span><br><span class="line">                <span class="keyword">if</span> (option.equals(tools[i][<span class="number">0</span>])) &#123;</span><br><span class="line">                    tool = tools[i][<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tool == <span class="keyword">null</span>) &#123;</span><br><span class="line">            usage();   <span class="comment">// no mapping to tool</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载相关的工具类, PMap, HeapSummary, HeapDumper, ObjectHistogram, PermStat, FinalizerInfo</span></span><br><span class="line">        Class&lt;?&gt; c = loadClass(tool);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            usage();</span><br><span class="line">        &#125;</span><br><span class="line">        Class[] argTypes = &#123; String[].class &#125; ;</span><br><span class="line">        Method m = c.getDeclaredMethod(<span class="string">&quot;main&quot;</span>, argTypes);</span><br><span class="line">        Object[] invokeArgs = &#123; args &#125;;</span><br><span class="line">        m.invoke(<span class="keyword">null</span>, invokeArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title">loadClass</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Class.forName(name, <span class="keyword">true</span>, ClassLoader.getSystemClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x)  &#123; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIVE_OBJECTS_OPTION = <span class="string">&quot;-live&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALL_OBJECTS_OPTION = <span class="string">&quot;-all&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">histo</span><span class="params">(String pid, <span class="keyword">boolean</span> live)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        VirtualMachine vm = attach(pid);</span><br><span class="line">        InputStream in = ((HotSpotVirtualMachine)vm).</span><br><span class="line">                heapHisto(live ? LIVE_OBJECTS_OPTION : ALL_OBJECTS_OPTION);</span><br><span class="line">        drain(vm, in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(String pid, String options)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 从options中将dump filename解析出来</span></span><br><span class="line">        String filename = parseDumpOptions(options);</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="keyword">null</span>) &#123;</span><br><span class="line">            usage();  <span class="comment">// invalid options or no filename</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get the canonical path - important to avoid just passing</span></span><br><span class="line">        <span class="comment">// a &quot;heap.bin&quot; and having the dump created in the target VM</span></span><br><span class="line">        <span class="comment">// working directory rather than the directory where jmap</span></span><br><span class="line">        <span class="comment">// is executed.</span></span><br><span class="line">        filename = <span class="keyword">new</span> File(filename).getCanonicalPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否只dump 存活的对象</span></span><br><span class="line">        <span class="keyword">boolean</span> live = isDumpLiveObjects(options);</span><br><span class="line"></span><br><span class="line">        VirtualMachine vm = attach(pid);</span><br><span class="line">        System.out.println(<span class="string">&quot;Dumping heap to &quot;</span> + filename + <span class="string">&quot; ...&quot;</span>);</span><br><span class="line">        InputStream in = ((HotSpotVirtualMachine)vm).</span><br><span class="line">                dumpHeap((Object)filename,</span><br><span class="line">                        (live ? LIVE_OBJECTS_OPTION : ALL_OBJECTS_OPTION));</span><br><span class="line">        drain(vm, in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析-dump选项. 合法的选项为format=b和file=&lt;file&gt;.</span></span><br><span class="line">    <span class="comment">// 如果文件存在的话, 就返回文件名。 如果文件不存在或者是非法选项的话则返回null</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseDumpOptions</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">assert</span> arg.startsWith(DUMP_OPTION_PREFIX);</span><br><span class="line"></span><br><span class="line">        String filename = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 将-dump:后面的参数以, 分割</span></span><br><span class="line">        String options[] = arg.substring(DUMP_OPTION_PREFIX.length()).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;options.length; i++) &#123;</span><br><span class="line">            String option = options[i];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (option.equals(<span class="string">&quot;format=b&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// ignore format (not needed at this time)</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option.equals(<span class="string">&quot;live&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// a valid suboption</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// file=&lt;file&gt; - check that &lt;file&gt; is specified</span></span><br><span class="line">                <span class="keyword">if</span> (option.startsWith(<span class="string">&quot;file=&quot;</span>)) &#123;</span><br><span class="line">                    filename = option.substring(<span class="number">5</span>);</span><br><span class="line">                    <span class="keyword">if</span> (filename.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;  <span class="comment">// option not recognized</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDumpLiveObjects</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">        String options[] = arg.substring(DUMP_OPTION_PREFIX.length()).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String suboption : options) &#123;</span><br><span class="line">            <span class="keyword">if</span> (suboption.equals(<span class="string">&quot;live&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach to &lt;pid&gt;, existing if we fail to attach</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> VirtualMachine <span class="title">attach</span><span class="params">(String pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> VirtualMachine.attach(pid);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            String msg = x.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.err.println(pid + <span class="string">&quot;: &quot;</span> + msg);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                x.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((x <span class="keyword">instanceof</span> AttachNotSupportedException) &amp;&amp; haveSA()) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;The -F option can be used when the &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;target process is not responding&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// keep compiler happy</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the stream from the target VM until EOF, then detach</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">drain</span><span class="params">(VirtualMachine vm, InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// read to EOF and just print output</span></span><br><span class="line">        <span class="keyword">byte</span> b[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">256</span>];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            n = in.read(b);</span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                String s = <span class="keyword">new</span> String(b, <span class="number">0</span>, n, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.print(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (n &gt; <span class="number">0</span>);</span><br><span class="line">        in.close();</span><br><span class="line">        vm.detach();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将arg加入到args中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] prepend(String arg, String args[]) &#123;</span><br><span class="line">        String[] newargs = <span class="keyword">new</span> String[args.length+<span class="number">1</span>];</span><br><span class="line">        newargs[<span class="number">0</span>] = arg;</span><br><span class="line">        System.arraycopy(args, <span class="number">0</span>, newargs, <span class="number">1</span>, args.length);</span><br><span class="line">        <span class="keyword">return</span> newargs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">haveSA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class c = loadClass(<span class="string">&quot;sun.jvm.hotspot.tools.HeapSummary&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (c != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// print usage message</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Usage:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (haveSA()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    jmap [option] &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to running process)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    jmap [option] &lt;executable &lt;core&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to a core file)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to remote debug server)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;where &lt;option&gt; is one of:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    &lt;none&gt;               to print same info as Solaris pmap&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -heap                to print java heap summary&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -histo[:live]        to print histogram of java object heap; if the \&quot;live\&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         suboption is specified, only count live objects&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -permstat            to print permanent generation statistics&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -finalizerinfo       to print information on objects awaiting finalization&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -dump:&lt;dump-options&gt; to dump java heap in hprof binary format&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         dump-options:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                           live         dump only live objects; if not specified,&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                                        all objects in the heap are dumped.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                           format=b     binary format&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                           file=&lt;file&gt;  dump heap to &lt;file&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         to force a heap dump or histogram when &lt;pid&gt; does not&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         respond. The \&quot;live\&quot; suboption is not supported&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;                         in this mode.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -h | -help           to print this help message&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    jmap -histo &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;      (to connect to running process and print histogram of java object heap&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    jmap -dump:&lt;dump-options&gt; &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;      (to connect to running process and dump java heap)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    dump-options:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;      format=b     binary default&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;      file=&lt;file&gt;  dump heap to &lt;file&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    Example:       jmap -dump:format=b,file=heap.bin &lt;pid&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h2><p>实时查看和调整虚拟机的各项参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">jinfo [ option ] pid</span><br><span class="line">Usage:</span><br><span class="line">    jinfo [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jinfo [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jinfo [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    -flag &lt;name&gt;         打印指定name的vm flag的值</span><br><span class="line">    -flag [+|-]&lt;name&gt;    将指定名称的 VM flag打开或者关闭</span><br><span class="line">    -flag &lt;name&gt;=&lt;value&gt; 将指定名称的 VM flag重新设置值</span><br><span class="line">    -flags               打印所有的 VM flags</span><br><span class="line">    -sysprops            打印 Java system properties</span><br><span class="line">    &lt;no option&gt;          如果没有选项的话就是执行上面的所有选项</span><br><span class="line">    -h | -help           to print this help message</span><br></pre></td></tr></table></figure>

<p>我们看到jinfo其实支持的是三种模式, 分别是本地进程, core文件和远程进程模式.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.tools.attach.HotSpotVirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span><br><span class="line">            usage(); <span class="comment">// no arguments</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> useSA = <span class="keyword">true</span>;</span><br><span class="line">        String arg1 = args[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (arg1.startsWith(<span class="string">&quot;-&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arg1.equals(<span class="string">&quot;-flags&quot;</span>) || arg1.equals(<span class="string">&quot;-sysprops&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// SA JInfo 需要 &lt;pid&gt; 或者 &lt;server&gt; 或者(&lt;executable&gt; and &lt;code file&gt;).</span></span><br><span class="line">                <span class="comment">// 因此 包含选项在内的所有参数应该是 2个 或者 3个.</span></span><br><span class="line">                <span class="keyword">if</span> (args.length != <span class="number">2</span> &amp;&amp; args.length != <span class="number">3</span>) &#123;</span><br><span class="line">                    usage();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arg1.equals(<span class="string">&quot;-flag&quot;</span>)) &#123;</span><br><span class="line">                useSA = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                usage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (useSA) &#123;</span><br><span class="line">            runTool(args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (args.length == <span class="number">3</span>) &#123;</span><br><span class="line">                String pid = args[<span class="number">2</span>];</span><br><span class="line">                String option = args[<span class="number">1</span>];</span><br><span class="line">                flag(pid, option);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                usage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用sa tool内部实现的jinfo</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTool</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String tool = <span class="string">&quot;sun.jvm.hotspot.tools.JInfo&quot;</span>;</span><br><span class="line">        Class&lt;?&gt; c = loadClass(tool);</span><br><span class="line">        Class[] argTypes = &#123; String[].class &#125;;</span><br><span class="line">        Method m = c.getDeclaredMethod(<span class="string">&quot;main&quot;</span>, argTypes);</span><br><span class="line"></span><br><span class="line">        Object[] invokeArgs = &#123; args &#125;;</span><br><span class="line">        m.invoke(<span class="keyword">null</span>, invokeArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title">loadClass</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 我们指定system class loader是为了在开发环境中 这个类可能在boot class path中，但是sa-jdi.jar却在system class path。</span></span><br><span class="line">        <span class="comment">// 一旦JDK被部署之后tools.jar 和 sa-jdi.jar 都会在system class path中。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Class.forName(name, <span class="keyword">true</span>, ClassLoader.getSystemClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用Attach API 实现的JInfo</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">flag</span><span class="params">(String pid, String option)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        VirtualMachine vm = attach(pid);</span><br><span class="line">        String flag;</span><br><span class="line">        InputStream in;</span><br><span class="line">        <span class="keyword">int</span> index = option.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">            flag = option.substring(<span class="number">0</span>, index);</span><br><span class="line">            String value = option.substring(index + <span class="number">1</span>);</span><br><span class="line">            in = ((HotSpotVirtualMachine) vm).setFlag(flag, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">char</span> c = option.charAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                flag = option.substring(<span class="number">1</span>);</span><br><span class="line">                in = ((HotSpotVirtualMachine) vm).setFlag(flag, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                flag = option.substring(<span class="number">1</span>);</span><br><span class="line">                in = ((HotSpotVirtualMachine) vm).setFlag(flag, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                flag = option;</span><br><span class="line">                in = ((HotSpotVirtualMachine) vm).printFlag(flag);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        drain(vm, in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach to &lt;pid&gt;, exiting if we fail to attach</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> VirtualMachine <span class="title">attach</span><span class="params">(String pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> VirtualMachine.attach(pid);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            String msg = x.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.err.println(pid + <span class="string">&quot;: &quot;</span> + msg);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                x.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// keep compiler happy</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the stream from the target VM until EOF, then detach</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">drain</span><span class="params">(VirtualMachine vm, InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// read to EOF and just print output</span></span><br><span class="line">        <span class="keyword">byte</span> b[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">256</span>];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            n = in.read(b);</span><br><span class="line">            <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                String s = <span class="keyword">new</span> String(b, <span class="number">0</span>, n, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.print(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (n &gt; <span class="number">0</span>);</span><br><span class="line">        in.close();</span><br><span class="line">        vm.detach();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// print usage message</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class c = loadClass(<span class="string">&quot;sun.jvm.hotspot.tools.JInfo&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> usageSA = (c != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Usage:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (usageSA) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    jinfo [option] &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to running process)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    jinfo [option] &lt;executable &lt;core&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to a core file)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    jinfo [option] [server_id@]&lt;remote server IP or hostname&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;        (to connect to remote debug server)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;where &lt;option&gt; is one of:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag &lt;name&gt;         to print the value of the named VM flag&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flags               to print VM flags&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -sysprops            to print Java system properties&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    &lt;no option&gt;          to print both of the above&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -h | -help           to print this help message&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    jinfo &lt;option&gt; &lt;pid&gt;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;       (to connect to a running process)&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;where &lt;option&gt; is one of:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag &lt;name&gt;         to print the value of the named VM flag&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;    -h | -help           to print this help message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JInfo 只有在使用<code>-flag</code>选项的时候才会使用<a href="">VM Attach API</a>,其他的选项都是使用<a href="">SA tools</a>实现的</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wangmingco.github.io/2016/09/24/Java/jvm/JVM%E5%B7%A5%E5%85%B7/" title="JVM 工具" target="_blank" rel="external">https://wangmingco.github.io/2016/09/24/Java/jvm/JVM工具/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/wangmingco" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/wangmingco" target="_blank"><span class="text-dark">王明</span><small class="ml-1x">Coder</small></a></h3>
        <div>一个纯粹的技术开发者。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2016/09/26/Java/javase/Java%20String/" title="Java 字符串优化"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2016/09/23/Java/javase/%E5%B9%B6%E5%8F%91%20wait%20sleep/" title="wait sleep 不同"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wangmingco" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://gitee.com/wangmingco" target="_blank" title="Gitee" data-toggle=tooltip data-placement=top><i class="icon icon-gitee"></i></a></li>
        
        <li><a href="https://weibo.com/wangmingco" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://www.zhihu.com/people/wangmingco" target="_blank" title="Zhihu" data-toggle=tooltip data-placement=top><i class="icon icon-zhihu"></i></a></li>
        
        <li><a href="https://www.douban.com/people/xxxyy/" target="_blank" title="Douban" data-toggle=tooltip data-placement=top><i class="icon icon-douban"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>