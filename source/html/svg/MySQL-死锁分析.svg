<svg xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" viewBox="0 0 1132 2391" width="1132" xmlns:xlink="http://www.w3.org/1999/xlink" height="2391"><defs/><g transform="translate(5.5,5.5)" id="page6"><rect width="1123" height="2381" x="0" y="0" fill="none"/><g transform="translate(63.000000,53.000000)" id="shape1"><path stroke="#101843" stroke-width="1" d="M849.0,835.0L849.0,.0L.0,.0L.0,835.0L849.0,835.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="4.0" y="19.0">2019-07-25 11:58:39 7f6b138f3700InnoDB: transactions deadlock detected, dumping detailed information.</tspan><tspan style="font-size:10.00pt" x="4.0" y="38.0">2019-07-25 11:58:39 7f6b138f3700</tspan><tspan style="font-size:10.00pt" x="4.0" y="57.0">*** (1) TRANSACTION:</tspan><tspan style="font-size:10.00pt" x="4.0" y="76.0">TRANSACTION 10734694262, ACTIVE 0 sec starting index read</tspan><tspan style="font-size:10.00pt" x="4.0" y="95.0">mysql tables in use 2, locked 2</tspan><tspan style="font-size:10.00pt" x="4.0" y="114.0">LOCK WAIT 3 lock struct(s), heap size 1184, 2 row lock(s)</tspan><tspan style="font-size:10.00pt" x="4.0" y="133.0">MySQL thread id 82598981, OS thread handle 0x7f6b7dfff700, query id 21934587738 10.19.25.252 settlement_s Searching rows for </tspan><tspan style="font-size:10.00pt" x="4.0" y="152.0">update</tspan><tspan style="font-size:10.00pt" x="4.0" y="171.0">update payment_channel_order</tspan><tspan style="font-size:10.00pt" x="4.0" y="190.0">         SET result_code = '1001',</tspan><tspan style="font-size:10.00pt" x="4.0" y="209.0">                result_msg = '银行账户余额不足，请换其他银行卡支付',</tspan><tspan style="font-size:10.00pt" x="4.0" y="228.0">                node_state = 8,</tspan><tspan style="font-size:10.00pt" x="4.0" y="247.0">                channel_result_code = 'DK00332',</tspan><tspan style="font-size:10.00pt" x="4.0" y="266.0">                channel_result_msg = '卡余额不足，请更换支付方式',</tspan><tspan style="font-size:10.00pt" x="4.0" y="285.0">                channel_finished_time = NOW(6),</tspan><tspan style="font-size:10.00pt" x="4.0" y="304.0">            update_time = now() </tspan><tspan style="font-size:10.00pt" x="4.0" y="323.0">        where id = 237297856 and node_state = 4</tspan><tspan style="font-size:10.00pt" x="4.0" y="342.0">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</tspan><tspan style="font-size:10.00pt" x="4.0" y="361.0">RECORD LOCKS space id 541 page no 804726 n bits 96 index `PRIMARY` of table `puhui_settlement`.`payment_channel_order` trx table </tspan><tspan style="font-size:10.00pt" x="4.0" y="380.0">locks 1 total table locks 22  trx id 10734694262 lock_mode X locks rec but not gap waiting lock hold time 0 wait time before grant 0 </tspan><tspan style="font-size:10.00pt" x="4.0" y="399.0">*** (2) TRANSACTION:</tspan><tspan style="font-size:10.00pt" x="4.0" y="418.0">TRANSACTION 10734694266, ACTIVE 0 sec updating or deleting</tspan><tspan style="font-size:10.00pt" x="4.0" y="437.0">mysql tables in use 1, locked 1</tspan><tspan style="font-size:10.00pt" x="4.0" y="456.0">3 lock struct(s), heap size 1184, 2 row lock(s), undo log entries 1</tspan><tspan style="font-size:10.00pt" x="4.0" y="475.0">MySQL thread id 82599677, OS thread handle 0x7f6b138f3700, query id 21934587849 10.19.36.54 settlement_s updating</tspan><tspan style="font-size:10.00pt" x="4.0" y="494.0">update payment_channel_order</tspan><tspan style="font-size:10.00pt" x="4.0" y="513.0">         SET result_code = '1003',</tspan><tspan style="font-size:10.00pt" x="4.0" y="532.0">                result_msg = '交易失败，请联系发卡行或更换其他银行卡支付',</tspan><tspan style="font-size:10.00pt" x="4.0" y="551.0">                node_state = 8,</tspan><tspan style="font-size:10.00pt" x="4.0" y="570.0">                channel_result_code = 'CLOS',</tspan><tspan style="font-size:10.00pt" x="4.0" y="589.0">                channel_result_msg = '账户可用余额或额度不足',</tspan><tspan style="font-size:10.00pt" x="4.0" y="608.0">                channel_finished_time = NOW(6),</tspan><tspan style="font-size:10.00pt" x="4.0" y="627.0">            update_time = now() </tspan><tspan style="font-size:10.00pt" x="4.0" y="646.0">        where id = 237297856 and node_state in (4,5,6,10,11,12)</tspan><tspan style="font-size:10.00pt" x="4.0" y="665.0">*** (2) HOLDS THE LOCK(S):</tspan><tspan style="font-size:10.00pt" x="4.0" y="684.0">RECORD LOCKS space id 541 page no 804726 n bits 96 index `PRIMARY` of table `puhui_settlement`.`payment_channel_order` trx table </tspan><tspan style="font-size:10.00pt" x="4.0" y="703.0">locks 1 total table locks 22  trx id 10734694266 lock_mode X locks rec but not gap lock hold time 0 wait time before grant 0 </tspan><tspan style="font-size:10.00pt" x="4.0" y="722.0">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</tspan><tspan style="font-size:10.00pt" x="4.0" y="741.0">RECORD LOCKS space id 541 page no 1028628 n bits 872 index `idx_node_state` of table `puhui_settlement`.`payment_channel_order` </tspan><tspan style="font-size:10.00pt" x="4.0" y="760.0">trx table locks 1 total table locks 22  trx id 10734694266 lock_mode X locks rec but not gap waiting lock hold time 0 wait time before </tspan><tspan style="font-size:10.00pt" x="4.0" y="779.0">grant 0 </tspan><tspan style="font-size:10.00pt" x="4.0" y="798.0">*** WE ROLL BACK TRANSACTION (1)</tspan></text></g><g transform="translate(82.000000,960.000000)" id="shape2"><path stroke="#101843" stroke-width="1" d="M433.0,180.0L433.0,7.0C433.0,3.1,429.9,.0,426.0,.0L7.0,.0C3.1,.0,.0,3.1,.0,7.0L.0,180.0C.0,183.9,3.1,187.0,7.0,187.0L426.0,187.0C429.9,187.0,433.0,183.9,433.0,180.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="4.0" y="19.0">update payment_channel_order</tspan><tspan style="font-size:10.00pt" x="4.0" y="38.0">SET result_code = '1001',</tspan><tspan style="font-size:10.00pt" x="4.0" y="57.0">        result_msg = '银行账户余额不足，请换其他银行卡支付',</tspan><tspan style="font-size:10.00pt" x="4.0" y="76.0">        node_state = 8,</tspan><tspan style="font-size:10.00pt" x="4.0" y="95.0">        channel_result_code = 'DK00332',</tspan><tspan style="font-size:10.00pt" x="4.0" y="114.0">        channel_result_msg = '卡余额不足，请更换支付方式',</tspan><tspan style="font-size:10.00pt" x="4.0" y="133.0">        channel_finished_time = NOW(6),</tspan><tspan style="font-size:10.00pt" x="4.0" y="152.0">        update_time = now()</tspan><tspan style="font-size:10.00pt" x="4.0" y="171.0">where id = 237297856 and node_state = 4</tspan></text></g><g transform="translate(614.500000,964.000000)" id="shape3"><path stroke="#101843" stroke-width="1" d="M433.0,180.0L433.0,7.0C433.0,3.1,429.9,.0,426.0,.0L7.0,.0C3.1,.0,.0,3.1,.0,7.0L.0,180.0C.0,183.9,3.1,187.0,7.0,187.0L426.0,187.0C429.9,187.0,433.0,183.9,433.0,180.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="4.0" y="19.0">update payment_channel_order</tspan><tspan style="font-size:10.00pt" x="4.0" y="38.0">SET result_code = '1003',</tspan><tspan style="font-size:10.00pt" x="4.0" y="57.0">    result_msg = '交易失败，请联系发卡行或更换其他银行卡支付',</tspan><tspan style="font-size:10.00pt" x="4.0" y="76.0">    node_state = 8,</tspan><tspan style="font-size:10.00pt" x="4.0" y="95.0">    channel_result_code = 'CLOS',</tspan><tspan style="font-size:10.00pt" x="4.0" y="114.0">    channel_result_msg = '账户可用余额或额度不足',</tspan><tspan style="font-size:10.00pt" x="4.0" y="133.0">    channel_finished_time = NOW(6),</tspan><tspan style="font-size:10.00pt" x="4.0" y="152.0">    update_time = now()</tspan><tspan style="font-size:10.00pt" x="4.0" y="171.0">where id = 237297856 and node_state in (4,5,6,10,11,12)</tspan></text></g><g transform="translate(82.000000,1168.000000)" id="shape4"><path stroke="#101843" stroke-width="1" d="M433.0,53.0L433.0,7.0C433.0,3.1,429.9,.0,426.0,.0L7.0,.0C3.1,.0,.0,3.1,.0,7.0L.0,53.0C.0,56.9,3.1,60.0,7.0,60.0L426.0,60.0C429.9,60.0,433.0,56.9,433.0,53.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="184.0" y="26.0">锁住的索引</tspan><tspan style="font-size:10.00pt" x="20.0" y="45.0">`PRIMARY` of table `puhui_settlement`.`payment_channel_order`</tspan></text></g><g transform="translate(614.500000,1161.500000)" id="shape5"><path stroke="#101843" stroke-width="1" d="M433.0,66.0L433.0,7.0C433.0,3.1,429.9,.0,426.0,.0L7.0,.0C3.1,.0,.0,3.1,.0,7.0L.0,66.0C.0,69.9,3.1,73.0,7.0,73.0L426.0,73.0C429.9,73.0,433.0,69.9,433.0,66.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="184.0" y="23.0">锁住的索引</tspan><tspan style="font-size:10.00pt" x="141.5" y="42.0">`idx_node_state` of table </tspan><tspan style="font-size:10.00pt" x="80.5" y="61.0">`puhui_settlement`.`payment_channel_order`</tspan></text></g><g transform="translate(82.000000,1350.000000)" id="shape6"><path stroke="#101843" stroke-width="1" d="M447.0,187.0L447.0,.0L.0,.0L.0,187.0L447.0,187.0z" fill-rule="nonzero" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="4.0" y="19.0">通过聚簇索引更新时，会在聚簇索引上加锁。</tspan><tspan style="font-size:10.00pt" x="10.8" y="38.0">1.</tspan><tspan style="font-size:10.00pt" x="24.0" y="38.0">通过二级索引进行更新时，会先对二级索引加锁，然后对聚簇索引加锁。</tspan><tspan style="font-size:10.00pt" x="10.8" y="57.0">2.</tspan><tspan style="font-size:10.00pt" x="24.0" y="57.0">使用聚簇索引更新二级索引时，会先对聚簇加锁，再对二级索引加锁。此</tspan><tspan style="font-size:10.00pt" x="24.0" y="76.0">结论的前提条件为结论4。</tspan><tspan style="font-size:10.00pt" x="10.8" y="95.0">3.</tspan><tspan style="font-size:10.00pt" x="24.0" y="95.0">更新二级索引时，只有二级索引所在的列产生实际变化的更新，才会对二</tspan><tspan style="font-size:10.00pt" x="24.0" y="114.0">级索引加锁，否则仅会对聚簇索引加锁。</tspan><tspan style="font-size:10.00pt" x="10.8" y="133.0">4.</tspan><tspan style="font-size:10.00pt" x="24.0" y="133.0">在REPEATABLE_READ级别下，对索引的加锁范围是索引所确定的范围，</tspan><tspan style="font-size:10.00pt" x="24.0" y="152.0">而不是最终结果集范围。也就是说需要回表查询才能剔除的行的聚簇索引</tspan><tspan style="font-size:10.00pt" x="24.0" y="171.0">依然会被加锁。而READ_COMMITTED级别下则不会。</tspan></text></g><g transform="translate(577.500000,1350.000000)" id="table7"><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,.0L249.8,.0L249.8,40.0L.0,40.0L.0,.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="9.0" y="25.5">事务A(通过左侧条件2执行)</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,.0L499.5,.0L499.5,40.0L249.8,40.0L249.8,.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="258.8" y="25.5">事务B(通过左侧条件1执行)</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,40.0L249.8,40.0L249.8,80.0L.0,80.0L.0,40.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:10.00pt"><tspan style="font-size:8.00pt" x="9.0" y="64.0">对主键PRIMARY加锁</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,40.0L499.5,40.0L499.5,80.0L249.8,80.0L249.8,40.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="258.8" y="65.5">对二级索引 idx_node_state 加锁</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,80.0L249.8,80.0L249.8,120.0L.0,120.0L.0,80.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,80.0L499.5,80.0L499.5,120.0L249.8,120.0L249.8,80.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,120.0L249.8,120.0L249.8,160.0L.0,160.0L.0,120.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="9.0" y="145.5">对二级索引 idx_node_state 加锁</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,120.0L499.5,120.0L499.5,160.0L249.8,160.0L249.8,120.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="258.8" y="145.5">对主键PRIMARY加锁</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,160.0L249.8,160.0L249.8,200.0L.0,200.0L.0,160.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,160.0L499.5,160.0L499.5,200.0L249.8,200.0L249.8,160.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,200.0L499.5,200.0L499.5,240.0L.0,240.0L.0,200.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"><tspan style="font-size:10.00pt" x="9.0" y="225.5">此时就产生了死锁</tspan></text></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,240.0L249.8,240.0L249.8,280.0L.0,280.0L.0,240.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,240.0L499.5,240.0L499.5,280.0L249.8,280.0L249.8,240.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M.0,280.0L249.8,280.0L249.8,320.0L.0,320.0L.0,280.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g><g><path stroke="#a0a0a4" stroke-width="1" d="M249.8,280.0L499.5,280.0L499.5,320.0L249.8,320.0L249.8,280.0z" fill="#ffffff"/><text xml:space="preserve" style="fill:#191919;font-family:微软雅黑,PingFang SC,Mircrosoft YaHei,Arial;font-size:12.50pt"/></g></g></g></svg>